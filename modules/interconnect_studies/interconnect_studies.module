<?php


require_once('/etc/mica/profiles/mica_distribution/modules/mica/extensions/mica_studies/mica_studies.module');

require_once('/etc/mica/sites/all/modules/interconnect_studies/interconnect_studies.features.inc');


/**
 * Implements hook_form_alter
 * To add dependent fields when filling out the form
 */
function interconnect_studies_form_alter(&$form, &$form_state, $form_id) {

  	 
  switch ($form_id) {
    case 'study_node_form':
		interconnect_studies_study_form_alter($form, $form_state, $form_id);
	break;
    case 'population_node_form':
      interconnect_studies_population_form_alter($form, $form_state, $form_id);
    break;
    case 'data_collection_event_node_form':
      interconnect_studies_data_collection_event_form_alter($form, $form_state, $form_id);
    break;
  }

}

function interconnect_studies_study_form_alter(&$form, &$form_state, $form_id) {
  
    //$form['#validate'][] = '_interconnect_studies_validate';
   
     $form['actions']['_mica_studies_save_add_population_submit'] = array(
    '#access' => TRUE,
    '#value' => t('Save & Add Sampling Frame'),
    '#weight' => 6,
    '#type' => 'submit',
    '#submit' => array('node_form_submit', '_mica_studies_save_add_population_submit'),
  );
  
  	// add some custom text
	
	$form['acustomtext'] = array(
        '#type' => 'item',
        '#markup' => '<div >   InterConnect (www.interconnect-diabetes.eu) is a European Union FP-7 funded project that
		aims to change the way that data is used in population research into the causes of diabetes and obesity. 
		It seeks to create the foundation to enable research to move from explaining the differences in risk of diabetes 
		and obesity within populations to being able to explain differences in risk between populations.
		<br>
		<br>
		A registry is being set up with the initial purpose of enabling researchers to discover studies relevant
		to studying gene-environment interaction on the risk of type 1 diabetes, type 2 diabetes or obesity. 
		This first phase of development of the registry is therefore focused on describing the key characteristics
		of studies in a searchable format. The registry data collection form has been designed with a view to minimising
		the request made of Investigators. We have populated it as fully as we can from publicly available information and
		therefore ask that you simply check that it is correct and add further information as appropriate. The entry will
		then be displayed on the InterConnect website as part of the study registry.
		<br>
		<br>
		No single study will have all the information required to understand the basis of difference in risk of diabetes 
		and obesity between populations and systems to facilitate cross-study analysis are required; the development of 
		the study registry is the first step in creating an integrated platform to this end. We hope that you will be 
		interested in engaging with InterConnect in the future, as we further develop the study registry with more 
		detailed information to support processes for data harmonisation and provide tools to facilitate international 
		collaboration and cross-study analyses.
		</div>',
        '#weight' => -10, // Adjust so that you can place it whereever 
        );

    $form['#groups']['group_general_info']->parent_name = '';
    $form['#groups']['group_methods']->parent_name = ''; 
	$form['#groups']['group_marker_paper']->parent_name = '';
	
	unset($form['#group_children']['group_general_info']);
	unset($form['#group_children']['group_methods']);
	unset($form['#group_children']['group_marker_paper']);
			
	$form['#groups']['group_general_info']->format_settings['formatter'] = 'open';
	$form['#groups']['group_methods']->format_settings['formatter'] = 'open';
	$form['#groups']['group_marker_paper']->format_settings['formatter'] = 'open';
	
$form['#groups']['group_access']->format_type = 'hidden';
$form['#groups']['group_authorization_maelstrom']->format_type = 'hidden';
$form['#groups']['group_authorization_specific']->format_type = 'hidden';
$form['#groups']['group_authorization']->format_type = 'hidden';
$form['#groups']['group_datasets']->format_type = 'hidden';
$form['#groups']['group_documents']->format_type = 'hidden';
//$form['#groups']['group_institution']->format_type = 'hidden';
$form['#groups']['group_methods']->format_type = 'hidden';
$form['#groups']['group_nb_participants']->format_type = 'hidden';
//$form['#groups']['group_pop_age']->format_type = 'hidden';
$form['#groups']['group_study_name']->format_type = 'hidden';
$form['#groups']['group_study_timeline']->format_type = 'hidden';
$form['#groups']['group_supp_info']->format_type = 'hidden';
$form['#groups']['group_target_nb_participants']->format_type = 'hidden';
$form['#groups']['group_target_nb_samples']->format_type = 'hidden';


	 
$form['body']['#type'] = 'hidden';
$form['field_access_biosamples']['#type'] = 'hidden';
$form['field_access_data']['#type'] = 'hidden';
$form['field_access_other']['#type'] = 'hidden';
$form['field_access_other_sp']['#type'] = 'hidden';
$form['field_address']['#type'] = 'hidden';
$form['field_authorising_date']['#type'] = 'hidden';
$form['field_authorising_date_m']['#type'] = 'hidden';
$form['field_authorising_person_name']['#type'] = 'hidden';
$form['field_authorising_person_name_m']['#type'] = 'hidden';
$form['field_authorization_maelstrom']['#type'] = 'hidden';
$form['field_authorization_specific']['#type'] = 'hidden';
$form['field_city']['#type'] = 'hidden';
$form['field_contact_country']['#type'] = 'hidden';
$form['field_contact_email']['#type'] = 'hidden';
$form['field_contact_name']['#type'] = 'hidden';
$form['field_department_unit']['#type'] = 'hidden';
$form['field_design']['#type'] = 'hidden';
$form['field_design_other_sp']['#type'] = 'hidden';
$form['field_documents']['#type'] = 'hidden';
$form['field_files']['#type'] = 'hidden';
$form['field_info_design_follow_up']['#type'] = 'hidden';
$form['field_institution_name']['#type'] = 'hidden';
$form['field_investigators']['#type'] = 'hidden';
$form['field_logo']['#type'] = 'hidden';
$form['field_no_limits_participants']['#type'] = 'hidden';
$form['field_no_limits_samples']['#type'] = 'hidden';
$form['field_postal_code']['#type'] = 'hidden';
$form['field_recruitment']['#type'] = 'hidden';
$form['field_recruitment_other_sp']['#type'] = 'hidden';
$form['field_recruitment_supp_info']['#type'] = 'hidden';
$form['field_state']['#type'] = 'hidden';
$form['field_study_end_year']['#type'] = 'hidden';
$form['field_study_start_year']['#type'] = 'hidden';
$form['field_study_study_variable_att']['#type'] = 'hidden';
$form['field_supp_infos']['#type'] = 'hidden';
$form['field_target_nb_supp_info']['#type'] = 'hidden';
$form['field_target_number_biosamples']['#type'] = 'hidden';
$form['field_target_number_participants']['#type'] = 'hidden';
$form['field_telephone']['#type'] = 'hidden';
$form['mica_dataset']['#type'] = 'hidden';
$form['mica_opal']['#type'] = 'hidden';

  
  // move study ref paper fields into general info
   
  $form['#group_children']['group_marker_paper'] = 'group_general_info';
  $form['#groups']['group_marker_paper']->weight = '5';
  $form['#groups']['group_marker_paper']->format_type = 'fieldset';
  $form['#groups']['group_marker_paper']->format_settings['formatter'] = 'open';

// adjust the weights of other fields

  $form['#group_children']['field_dna_ic'] = 'group_general_info';
  $form['field_dna_ic']['#weight'] = '7';

 // move study study design group into general info
    $form['#group_children']['group_study_design'] = 'group_general_info';
	$form['#groups']['group_study_design']->weight = '8';
	
// move the new study design fields into the right group

  $form['#group_children']['field_design_ic'] = 'group_study_design';
  $form['field_design_ic']['#weight'] = '1';

  $form['#group_children']['field_design_other_ic'] = 'group_study_design';
  $form['field_design_other_ic']['#weight'] = '2';
  
  $form['#group_children']['field_trial_number_ic'] = 'group_study_design';
  $form['field_trial_number_ic']['#weight'] = '1';  

  $form['#group_children']['field_b_line_rec_start_ic'] = 'group_study_design';
  $form['field_b_line_rec_start_ic']['#weight'] = '2';
  
  $form['#group_children']['field_b_line_rec_status_ic'] = 'group_study_design';
  $form['field_b_line_rec_status_ic']['#weight'] = '3';
  
  $form['#group_children']['field_b_line_rec_end_ic'] = 'group_study_design';
  $form['field_b_line_rec_end_ic']['#weight'] = '4';
  
  $form['#group_children']['field_number_of_participants_ic'] = 'group_study_design';
  $form['field_number_of_participants_ic']['#weight'] = '5';

  $form['#group_children']['field_participants_date_ic'] = 'group_study_design';
  $form['field_participants_date_ic']['#weight'] = '6';

  $form['#group_children']['field_follow_up_ic'] = 'group_study_design';
  $form['field_follow_up_ic']['#weight'] = '7';
  
  $form['#group_children']['field_follow_up_date_ic'] = 'group_study_design';
  $form['field_follow_up_date_ic']['#weight'] = '8';

  $form['#group_children']['field_interv_type_ic'] = 'group_study_design';
  $form['field_interv_type_ic']['#weight'] = '9';
  
  $form['#group_children']['field_interv_other_ic'] = 'group_study_design';
  $form['field_interv_other_ic']['#weight'] = '10';   
  
  $form['#group_children']['field_outcomes_ic'] = 'group_study_design';
  $form['field_outcomes_ic']['#weight'] = '11';
  
  $form['#group_children']['field_oc_other_pr_diabetes_ic'] = 'group_study_design';
  $form['field_oc_other_pr_diabetes_ic']['#weight'] = '12';
  
  $form['#group_children']['field_oc_other_inc_diabetes_ic'] = 'group_study_design';
  $form['field_oc_other_inc_diabetes_ic']['#weight'] = '13';
  
  $form['#group_children']['field_prev_disease_ic'] = 'group_study_design';
  $form['field_prev_disease_ic']['#weight'] = '11';
  
  $form['#group_children']['field_prev_disease_other_ic'] = 'group_study_design';
  $form['field_prev_disease_other_ic']['#weight'] = '12';
  
  $form['#group_children']['field_other_pr_diabetes_ic'] = 'group_study_design';
  $form['field_other_pr_diabetes_ic']['#weight'] = '12';

  $form['#group_children']['field_case_definition_ic'] = 'group_study_design';
  $form['field_case_definition_ic']['#weight'] = '11'; 

 //move the key lifestyle information group into general info group
 
     $form['#group_children']['group_key_exposures_ic'] = 'group_general_info';
	$form['#groups']['group_key_exposures_ic']->weight = '7';
  
  //set up dependent fields for study design
  
$options = array(
	'case_control',
	'case_only',
	'clinical_trial',
	'cohort_study',
	'cross_sectional',
	'other',
	'none'
	);
//	$form['field_design_ic']['und']['#default_value'] = '_none';
	
	
$visible_options = array(
		'clinical_trial',
	'cohort_study');
	
   _double_simple($form, 'field_design_ic', 'field_outcomes_ic', $options, $visible_options);
   _mica_add_dependent_field_checked($form, 'field_outcomes_ic', 'field_oc_other_pr_diabetes_ic', 'OD_p');
   _mica_add_dependent_field_checked($form, 'field_outcomes_ic', 'field_oc_other_inc_diabetes_ic', 'OD_i');
   
// clinical trial only   
   
   _mica_add_dependent_field_checked($form, 'field_design_ic', 'field_interv_type_ic', 'clinical_trial');
   _mica_add_dependent_field_checked($form, 'field_interv_type_ic', 'field_interv_other_ic', 'other');
   _mica_add_dependent_field_checked($form, 'field_design_ic', 'field_trial_number_ic', 'clinical_trial');   
	
// cross sectional trial only   

  _mica_add_dependent_field_checked($form, 'field_design_ic', 'field_prev_disease_ic', 'cross_sectional');
  _mica_add_dependent_field_checked($form, 'field_prev_disease_ic', 'field_prev_disease_other_ic', 'other');

// case control only

 // _mica_add_dependent_field_checked($form, 'field_design_ic', 'field_num_cases_ic', 'case_control');
 //  _mica_add_dependent_field_checked($form, 'field_design_ic', 'field_num_controls_ic', 'case_control');

    $visible_options = array(
		'case_control',
	'case_only');
  _double_simple($form, 'field_design_ic', 'field_case_definition_ic', $options, $visible_options);
  _mica_add_dependent_field_checked($form, 'field_case_definition_ic', 'field_other_pr_diabetes_ic', 'other');

// for the baseline and number of participant fields, these appear for all options
	$visible_options = array(
	'case_control',
	'case_only',
	'clinical_trial',
	'cohort_study',
	'cross_sectional',
	'other'
	);
    _double_simple($form, 'field_design_ic', 'field_b_line_rec_start_ic', $options, $visible_options);
    _double_simple($form, 'field_design_ic', 'field_b_line_rec_status_ic', $options, $visible_options);
    _double_simple($form, 'field_design_ic', 'field_b_line_rec_end_ic', $options, $visible_options);
    _double_simple($form, 'field_design_ic', 'field_number_of_participants_ic', $options, $visible_options);
    _double_simple($form, 'field_design_ic', 'field_participants_date_ic', $options, $visible_options);
	_mica_add_dependent_field_checked($form, 'field_b_line_rec_status_ic', 'field_b_line_rec_end_ic', '0');


// follow up fields for cohort and clinical trial
	$visible_options = array(
		'clinical_trial',
		'cohort_study');
			
	_double_simple($form, 'field_design_ic', 'field_follow_up_ic', $options, $visible_options);
    _double_simple($form, 'field_design_ic', 'field_follow_up_date_ic', $options, $visible_options);
	_mica_add_dependent_field_checked($form, 'field_follow_up_ic', 'field_follow_up_date_ic', '0');

// other study design

   _mica_add_dependent_field_checked($form, 'field_design_ic', 'field_design_other_ic', 'other'); 
	
// bespoke filled state for race group other text

  $form['field_race_other_text_ic']['#states']['visible'] = array(
        ':input[name="field_race_other_ic[und][0][value]"]' => array('filled' => TRUE),
	);	
  
dpm($form, $name = NULL);

}

function interconnect_studies_population_form_alter(&$form, &$form_state, $form_id) {
	
	// hide old fields
	$form['body']['#type'] = 'hidden';
	$form['field_pop_dce']['#type'] = 'hidden';
	$form['field_pop_ethnic_origin']['#type'] = 'hidden';
	$form['field_pop_exist_study_part']['#type'] = 'hidden';
	$form['field_pop_gender']['#type'] = 'hidden';
	$form['field_pop_general_pop_recruit']['#type'] = 'hidden';
	$form['field_pop_health_status']['#type'] = 'hidden';
	$form['field_pop_no_lim_participants_s']['#type'] = 'hidden';
	$form['field_pop_no_limits_participants']['#type'] = 'hidden';
	$form['field_pop_partcipant_sel_supp_in']['#type'] = 'hidden';
	$form['field_pop_participants_nb']['#type'] = 'hidden';
	$form['field_pop_participants_nb_s']['#type'] = 'hidden';
	$form['field_pop_participants_nb_supp_i']['#type'] = 'hidden';
	$form['field_pop_recruit_supp_info']['#type'] = 'hidden';
	$form['field_pop_recruitment_other']['#type'] = 'hidden';
	$form['field_pop_select_criteria']['#type'] = 'hidden';
	$form['field_pop_selection_others_sp']['#type'] = 'hidden';
	$form['field_pop_specific_pop']['#type'] = 'hidden';
	$form['field_pop_specific_pop_other_sp']['#type'] = 'hidden';
	$form['field_pop_src_recruit']['#type'] = 'hidden';
	$form['field_pop_study']['#type'] = 'hidden';
	$form['field_pop_supp_infos']['#type'] = 'hidden';
	$form['field_pop_territory']['#type'] = 'hidden';

	//hide groups
	
	$form['#groups']['group_general_info']->format_type = 'hidden';
	$form['#groups']['group_pop_age']->format_type = 'hidden';
	$form['#groups']['group_pop_countries']->format_type = 'hidden';
	$form['#groups']['group_pop_participants_number']->format_type = 'hidden';
	//$form['#groups']['group_pop_recruitment_procedures']->format_type = 'hidden';
	$form['#groups']['group_pop_selection_criteria']->format_type = 'hidden';
	$form['#groups']['group_pop_supp_info']->format_type = 'hidden';	

	// add some custom text
	
	// $form['acustomtext'] = array(
        // '#type' => 'item',
        // '#markup' => '<div > All studies represent samples from a within a larger population and the term 
		// sampling frame defines those within the population who were sampled. Some studies will have multiple
		// sampling frames. Please complete the next questions for each separate sampling frame. </div>',
        // '#weight' => -10, // Adjust so that you can place it whereever 
        // );
	
	// set the title
	
	//if ($form_id == 'population_node_form') {
    //    drupal_set_title(t("Create Sampling Frame"));
    //  }
	
	
	// move title field to sampling frame group
	
	// $form['#group_children']['title_field'] = 'group_pop_sampling_frame_ic';
	// $form['title_field']['#weight'] = '1';
	
	//move new fields to recruitment procedure group
	
	$form['#group_children']['field_pop_recruitment_proc_ic'] = 'group_pop_recruitment_procedures';
	$form['field_pop_recruitment_proc_ic']['#weight'] = '10';

	$form['#group_children']['field_pop_rec_proc_select_ic'] = 'group_pop_recruitment_procedures';
	$form['field_pop_rec_proc_select_ic']['#weight'] = '11';
	
	$form['#group_children']['field_pop_rec_proc_locality_ic'] = 'group_pop_recruitment_procedures';
	$form['field_pop_rec_proc_locality_ic']['#weight'] = '12';
	
	$form['#group_children']['field_pop_rec_proc_occup_ic'] = 'group_pop_recruitment_procedures';
	$form['field_pop_rec_proc_occup_ic']['#weight'] = '13';

	$form['#group_children']['field_pop_rec_proc_gender_ic'] = 'group_pop_recruitment_procedures';
	$form['field_pop_rec_proc_gender_ic']['#weight'] = '14';

	$form['#group_children']['field_pop_rec_proc_other_ic'] = 'group_pop_recruitment_procedures';
	$form['field_pop_rec_proc_other_ic']['#weight'] = '15';

	_mica_add_dependent_field_checked($form, 'field_pop_recruitment_proc_ic', 'field_pop_rec_proc_select_ic',  'sel');
	_mica_add_dependent_field_checked($form, 'field_pop_rec_proc_select_ic', 'field_pop_rec_proc_locality_ic', 'loc');
	_mica_add_dependent_field_checked($form, 'field_pop_rec_proc_select_ic', 'field_pop_rec_proc_occup_ic', 'occ');
	_mica_add_dependent_field_checked($form, 'field_pop_rec_proc_select_ic', 'field_pop_rec_proc_gender_ic', 'gen');	
	_mica_add_dependent_field_checked($form, 'field_pop_rec_proc_select_ic', 'field_pop_rec_proc_other_ic', 'other');

	_mica_add_dependent_field_checked($form, 'field_pop_rec_target_ic', 'field_pop_rec_target_other_ic', 'other');	

     $form['actions']['_mica_studies_save_add_dce_submit'] = array(
    '#access' => TRUE,
    '#value' => t('Save & Add Sampling Frame'),
    '#weight' => 6,
    '#type' => 'hidden',
    '#submit' => array('node_form_submit', '_mica_studies_save_add_population_submit'),
  );	
   
//dpm($form, $name = NULL);
}

 function _interconnect_studies_validate($node, $form) {

  //dpm($node, $name = NULL);

 debug($node['field_african_african_american_b']['und']['0']['value']['#value']); 

 $total = $node['field_african_african_american_b']['und']['0']['value']['#value'] + $node['field_caucasian_european_white']['und']['0']['value']['#value']
			+ $node['field_asian_native_american']['und']['0']['value']['#value'] + $node['field_other_ancestry']['und']['0']['value']['#value'];
 debug($total);

if($total != 100){
    form_set_error('title', 'The ancestries must sum to 100% ');
    
}

}



function _double_simple(&$form, $dependee, $dependent, $options, $visible_options) {
	$lang = $form[$dependee]['#language'];
	$input = ':input[name="' . $dependee . '[' . $lang . ']"]';
	foreach (array_diff($options, $visible_options) as $i => $vocab) {
	$form[$dependent]['#states']['visible'][$input . ', my-nonsense-dummy-element-' . $i] =
		array('!value' => $vocab);

		}
}

